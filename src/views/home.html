<div fm-sticky="sticky-class">
  <header class="fm-header corporative">
    <h4 class="fm-regular">
      {{session.flat.name}}
    </h4>
    <button class="fm-icon right" ng-click="logout()" style="display: none">
      <i class="fa fa-power-off"></i>
    </button>
    <ul fm-drop-down>
      <li ng-if="session._id === session.flat.owner._id">
        <a href="#/edit-flat">
          EDITAR PISO
        </a>
      </li>
      <li>
        <button ng-click="logout()">POWER OFF</button>
      </li>
    </ul>
  </header>

  <section fm-tabs ng-if="session.flat" class="fm-tabs-wrapper">
    <li fm-tab class="fm-tab" ng-click="changePaneTo(0)">Mis tareas</li>
    <li fm-tab class="fm-tab" ng-click="changePaneTo(1)">Tareas</li>
    <div fm-indicator class="fm-indicator"></div>
  </section>
</div>

<!-- TODO make a directive to show the task card -->
<section class="fm-wrapper-panes" fm-panes selected="paneActive">
  <div fm-pane class="fm-pane">
    <ul class="fm-cards-wrapper">
      <li class="fm-card clear" ng-repeat="task in session.flat.tasks track by $index"
          ng-if="(task | isMyTask :session.flat.mates) && !(task | taskIsDone)">
        <div ng-if="!task.spin">
          <header>
            <i class="fm-card-icon-type fa fa-align-left"></i>
          </header>
          <p>{{task.title}}</p>
          <button class="fm-button-soft to-right"
                  ng-click="markTaskAsDone(task)">
            Finalizar tarea
          </button>
        </div>
        <div ng-if="task.spin">
          <header>
            <i class="fm-card-icon-type fa fa-rotate-right"></i>
          </header>
          <p>{{task.title}}: {{task.history | spinTaskForMe}}</p>
          <button class="fm-button-soft to-right"
                  ng-click="markTaskAsDone(task)">
            Finalizar tarea
          </button>
        </div>
      </li>

      <li class="fm-empty-card-list" ng-if="messageEmptyFlatOrTasks()">
        {{messageEmptyFlatOrTasks()}}
        <div ng-if="!session.flat">
          <button class="fm-button" ng-click="newFlatButton()">
            Crear piso
          </button>
        </div>
      </li>

      <li class="fm-empty-card-list"
          ng-if="session.flat.tasks && !messageEmptyFlatOrTasks() &&
                 (session.flat.tasks | noTasksForMe :session.flat.mates)">
        No tienes tareas pendientes
      </li>
    </ul>
  </div>
  <div fm-pane class="fm-pane">
    <ul class="fm-cards-wrapper">
      <li class="fm-card clear" ng-repeat="task in session.flat.tasks track by $index"
          ng-if="(!task.spin && !task.done) ||
                 (task.spin && (task | spinTaskAllDone))">
        <div ng-if="!task.spin">
          <header>
            <i class="fm-card-icon-type fa fa-align-left"></i>
          </header>
          <p>
            {{task.title}}
            <span class="fm-cad-who">
              <i class="fa fa-long-arrow-right"></i>
              {{task.who | whoIs :session.flat.mates}}
            </span>
          </p>
          <button class="fm-button-soft to-right"
                  ng-click="markTaskAsDone(task)">
            Finalizar tarea
          </button>
        </div>
        <div ng-if="task.spin">
          <header>
            <i class="fm-card-icon-type fa fa-rotate-right"></i>
          </header>
          <p>
            {{task.title}}
            <ul>
              <li ng-repeat="subtask in task.history[task.history.length - 1].subtasks"
              ng-if="!subtask.done">
                - {{subtask.subtask.value}}
                <span class="fm-cad-who">
                  <i class="fa fa-long-arrow-right"></i>
                  {{subtask.who | whoIs :session.flat.mates}}
                </span>
              </li>
            </ul>
          </p>
        </div>
      </li>
      <li class="fm-empty-card-list" ng-if="!session.flat.tasks.length">
        {{messageEmptyFlatOrTasks()}}
      </li>
    </ul>
  </div>
</section>

<div fm-main-button actions="mainActions" ng-if="session.flat">
  <button fm-main-button-action ng-click="simpleTask($event)">
    <label>Nueva tarea</label>
    <i class="fa fa-align-left"></i>
  </button>
  <button fm-main-button-action ng-click="spinTask($event)">
    <label>Nueva tarea rotatoria</label>
    <i class="fa fa-rotate-right"></i>
  </button>
</div>
